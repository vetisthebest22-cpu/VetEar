<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VETai - Medical Auscultation Analysis Results</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands/dist/speech-commands.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .bar-animation { transition: width 0.8s ease-out; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-6 py-8">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800">Auscultation Analysis Results</h1>
      <div class="flex items-center space-x-3 bg-white px-6 py-3 rounded-lg shadow-md">
        <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
          <path d="M19.5 3.5L18 2l-1.5 1.5L15 2l-1.5 1.5L12 2l-1.5 1.5L9 2L7.5 3.5L6 2v4c0 3.31 2.69 6 6 6s6-2.69 6-6V2l-1.5 1.5zM12 10c-2.21 0-4-1.79-4-4V4.5l1 1 1.5-1.5L12 5.5l1.5-1.5L15 5.5l1-1V6c0 2.21-1.79 4-4 4z"/>
          <path d="M12 12c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2s2-.9 2-2v-6c0-1.1-.9-2-2-2zm0 7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
        </svg>
        <div>
          <div class="text-lg font-bold text-gray-800">VETai</div>
          <div class="text-sm text-gray-600">NEW AIR OF VET</div>
        </div>
      </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-8">
      <div class="bg-white rounded-xl shadow-lg p-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Sound Analysis Results</h2>
        <div id="results" class="space-y-6"></div>
        <div class="mt-8 p-4 bg-gray-50 rounded-lg">
          <div class="text-sm text-gray-600 mb-2">Analysis Summary</div>
          <div class="flex justify-between text-sm">
            <span>Total Detected Sounds:</span>
            <span id="total-sounds" class="font-semibold">0%</span>
          </div>
          <div class="flex justify-between text-sm">
            <span>Confidence Level:</span>
            <span id="confidence" class="font-semibold text-green-600">--</span>
          </div>
        </div>
        <button onclick="startAnalysis()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200">
          Start Analysis
        </button>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Sound Classifications</h2>
        <div class="space-y-6">
          <div class="border-l-4 border-red-500 pl-4 py-3">
            <h3 class="font-semibold text-gray-800 mb-2">Background Noise</h3>
            <p class="text-gray-600 text-sm">Refers to surrounding noise during auscultation, including environment, equipment, or movement artifacts.</p>
          </div>
          <div class="border-l-4 border-green-500 pl-4 py-3">
            <h3 class="font-semibold text-gray-800 mb-2">Human – Normal</h3>
            <p class="text-gray-600 text-sm">Typical lung/airway sounds in a healthy person without abnormal breath sounds.</p>
          </div>
          <div class="border-l-4 border-blue-500 pl-4 py-3">
            <h3 class="font-semibold text-gray-800 mb-2">Small Animal – Normal</h3>
            <p class="text-gray-600 text-sm">Normal respiratory sounds of small animals, showing clear airways and healthy lung function.</p>
          </div>
          <div class="border-l-4 border-orange-500 pl-4 py-3">
            <h3 class="font-semibold text-gray-800 mb-2">Wheezing</h3>
            <p class="text-gray-600 text-sm">High-pitched whistling during inhalation/exhalation, caused by narrowed or obstructed airways.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-8 text-center text-sm text-gray-500">
      <p>AI-powered auscultation analysis • Results generated on <span id="currentDate"></span></p>
    </div>
  </div>

  <script>
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString();

    const URL = "https://vetisthebest22-cpu.github.io/VetEar/my_model/";
    let recognizer, classLabels = [];
    let lastUpdate = {}; // لتخزين وقت آخر تحديث لكل بار

    async function loadModel() {
      const checkpointURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";
      recognizer = speechCommands.create("BROWSER_FFT", undefined, checkpointURL, metadataURL);
      await recognizer.ensureModelLoaded();
      classLabels = recognizer.wordLabels();
      renderBars();
    }

    function renderBars() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = "";
      classLabels.forEach(label => {
        resultsDiv.innerHTML += `
          <div class="sound-result">
            <div class="flex justify-between items-center mb-2">
              <span class="font-medium text-gray-700">${label}</span>
              <span id="${label}-val" class="text-lg font-bold">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
              <div id="${label}-bar" class="bar-animation h-6 rounded-full shadow-sm bg-blue-500" style="width:0%"></div>
            </div>
          </div>`;
        lastUpdate[label] = 0; // تهيئة وقت آخر تحديث
      });
    }

    async function startAnalysis() {
      if (!recognizer) await loadModel();
      recognizer.listen(result => {
        const now = Date.now();
        const scores = result.scores.map(s => (s * 100).toFixed(2)); // منزلتين عشريتين
        let total = 0;
        classLabels.forEach((label, i) => {
          if (now - lastUpdate[label] > 10000) { // تحديث كل 10 ثواني
            document.getElementById(label + "-val").textContent = scores[i] + "%";
            document.getElementById(label + "-bar").style.width = scores[i] + "%";
            lastUpdate[label] = now;
          }
          total += parseFloat(scores[i]);
        });
        document.getElementById("total-sounds").textContent = total.toFixed(2) + "%";
        document.getElementById("confidence").textContent = "High (" + Math.max(...scores) + "%)";
      }, {
        includeSpectrogram: true,
        probabilityThreshold: 0.0,
        overlapFactor: 0.5
      });
    }

    loadModel();
  </script>
</body>
</html>
