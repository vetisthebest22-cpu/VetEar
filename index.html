<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<style>
    /* Popup style */
    #sound-popup {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #7C3AED, #10B981);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(124,58,237,0.3);
        display: none;
        z-index: 50;
        min-width: 250px;
        font-weight: 600;
    }

    #sound-popup .close-btn {
        position: absolute;
        top: 5px;
        right: 10px;
        cursor: pointer;
        font-weight: bold;
    }
</style>

<div id="sound-popup">
    <span class="close-btn" onclick="document.getElementById('sound-popup').style.display='none'">✖</span>
    <div id="sound-text"></div>
</div>

<script>
    let recognizer;
    let isListening = false;

    async function initAIModel() {
        const MODEL_URL = "./my_model/";
        recognizer = speechCommands.create("BROWSER_FFT", undefined, MODEL_URL + "model.json", MODEL_URL + "metadata.json");
        await recognizer.ensureModelLoaded();
        console.log("AI Model loaded.");
    }

    async function toggleListening() {
        const button = document.querySelector('.mic-button');
        isListening = !isListening;

        if (!recognizer) await initAIModel();

        if (isListening) {
            button.style.animation = 'pulse 0.5s ease-in-out infinite';
            button.style.background = 'linear-gradient(135deg, #10B981, #7C3AED)';
            startListening();
        } else {
            button.style.animation = 'pulse 2s ease-in-out infinite';
            button.style.background = 'linear-gradient(135deg, #7C3AED, #10B981)';
            if (recognizer) recognizer.stopListening();
        }
    }

    function startListening() {
        recognizer.listen(result => {
            const scores = result.scores;
            const labels = recognizer.wordLabels();
            // Find highest probability
            let maxIndex = 0;
            let maxScore = 0;
            scores.forEach((s, i) => { if(s > maxScore){ maxScore=s; maxIndex=i; }});

            const detectedSound = labels[maxIndex];
            const percentage = (maxScore*100).toFixed(1);

            // Show popup
            const popup = document.getElementById('sound-popup');
            const text = document.getElementById('sound-text');
            text.textContent = `The sound is "${detectedSound}" with Percentage ${percentage}%`;
            popup.style.display = 'block';

            // Update radial progress bars
            updateProgress('noise-progress','noise-text', Math.round(scores[labels.indexOf('Background Noise')]*100 || 0));
            updateProgress('human-progress','human-text', Math.round(scores[labels.indexOf('Human - Normal')]*100 || 0));
            updateProgress('animal-progress','animal-text', Math.round(scores[labels.indexOf('Small Animal - Normal')]*100 || 0));
            updateProgress('wheeze-progress','wheeze-text', Math.round(scores[labels.indexOf('Wheezing')]*100 || 0));

            // Update recommendation based on max class
            const recText = document.getElementById('recommendation-text');
            if(detectedSound === 'Wheezing') {
                recText.textContent = "⚠️ Wheezing detected! Recommend immediate veterinary attention.";
            } else if(detectedSound === 'Small Animal - Normal') {
                recText.textContent = "Healthy small animal detected. Continue regular monitoring.";
            } else {
                recText.textContent = "Background or human noise detected. Try focusing on the animal's sound.";
            }
        }, {
            includeSpectrogram:true,
            probabilityThreshold:0,
            overlapFactor:0.5
        });
    }

    // Initialize progress bars with default values
    document.addEventListener('DOMContentLoaded', function() {
        updateProgress('noise-progress', 'noise-text', 15);
        updateProgress('human-progress', 'human-text', 25);
        updateProgress('animal-progress', 'animal-text', 85);
        updateProgress('wheeze-progress', 'wheeze-text', 8);
    });
</script>

